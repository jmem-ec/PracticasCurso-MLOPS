En proyectos de ciencia de datos o machine learning, los conjuntos de datos y modelos pueden ser muy grandes y dif√≠ciles de gestionar dentro de Git. Para resolver esto, DVC (Data Version Control) ofrece una forma eficiente de versionar y compartir archivos grandes sin almacenarlos directamente en el repositorio.

DVC permite configurar un almacenamiento remoto (Remote Storage) para sincronizar autom√°ticamente los archivos grandes con servicios como Google Cloud Storage, Google Drive, S3, entre otros. As√≠, se facilita la colaboraci√≥n en equipo y la reproducci√≥n de experimentos.

> üìùDVC act√∫a como un complemento de Git: mientras Git versiona el c√≥digo, DVC se encarga de los datos y modelos.

## üéØ Objetivos
Aprender a gestionar datos de forma eficiente y colaborativa en proyectos de ciencia de datos mediante la herramienta DVC (Data Version Control). Al finalizar esta pr√°ctica, podr√°s:

- Instalar y configurar DVC en tu entorno local.
- Entender c√≥mo DVC complementa a Git para versionar y rastrear archivos grandes.
- Configurar un almacenamiento remoto para compartir datos con tu equipo.

## Requisitos Previos

- Tener instalado git.
- Contar con una cuenta de Google.

## Instalaci√≥n de DVC
> üí° Se recomienda realizar esta instalaci√≥n dentro de un entorno Conda previamente creado para el proyecto.

1. Verifica que tienes tu entorno Conda activo

2. Para instalar DVC, la forma m√°s directa es usando `pip`, ya que DVC se encuentra activamente mantenido en PyPI. Se recomienda para esta practica instalar DVC con soporte para almacenamiento en la nube. 

    Para usar Google Drive:
        ```bash
        pip install 'dvc[gdrive]'
        ```
    Y para usar Google Cloud Storage
        ```bash
        pip install 'dvc[gcs]'
        ```

    > üí° Se puede usar el comando `pip install 'dvc[all]'` para instalar soporte para todos los  principales backends de almacenamiento remoto, incluyendo:
    >
    >   - Google Drive (gdrive)
    >   - Google Cloud Storage (gcs)
    >   - Amazon S3 (s3)
    >   - Azure Blob Storage (azure)
    >   - SSH, HDFS, WebDAV, entre otros.
    >
    > Porsupuesto, la instalaci√≥n con `[all]` puede tardar m√°s y ocupar m√°s espacio, ya que instala muchas dependencias adicionales.
    > Tambi√©n puede usar `pip install "dvc[gdrive, gcs]"`

3. Verificar instalaci√≥n
    ```bash
    dvc --version
    ```
## Parte 1: Configurar Google Drive como almacenamiento remoto en DVC

Google Drive puede usarse como un almacenamiento remoto para proyectos gestionados con DVC. Esta opci√≥n es √∫til para proyectos colaborativos que usan almacenamiento en la nube gratuito y accesible. A continuaci√≥n se detallan los pasos para conectar tu proyecto a Google Drive.


### üîê Obtener credenciales para conectar DVC con Google Drive
En la [gu√≠a oficial de DVC para la configuraci√≥n de almacenamiento remoto con Google Drive](https://dvc.org/doc/user-guide/data-management/remote-storage/google-drive) se describen varias formas de conexi√≥n. Sin embargo, para este proyecto se recomienda configurar una cuenta de servicio para conectar el almacenamiento remoto con tu proyecto DVC.

Esta opci√≥n ofrece varias ventajas, especialmente en escenarios donde el acceso a los datos debe realizarse de forma autom√°tica, como en entornos de c√≥mputo en la nube, procesos de integraci√≥n y entrega continua (CI/CD), entre otros. A diferencia de la autenticaci√≥n interactiva con OAuth, el uso de una cuenta de servicio permite el acceso sin intervenci√≥n manual del usuario.

1. Accede a Google Cloud Console

    - Ve a: [https://console.cloud.google.com](https://console.cloud.google.com)
    
2. Crea un proyecto (si a√∫n no lo tienes)

    - Men√∫ ‚Üí IAM & Admin ‚Üí Manage resources ‚Üí Create a project.    

3. Activa la API de Google Drive

    - Men√∫ ‚Üí APIs & Services ‚Üí Library ‚Üí Busca Google Drive API ‚Üí Haz clic en Enable.

4. Crea una cuenta de servicio

    - Men√∫ ‚Üí IAM & Admin ‚Üí Service Accounts ‚Üí Haz clic en Create Service Account.

    - Nombre de la cuenta (ejemplo): dvc-service

    - ID de la cuenta: se autogenera

    - En los siguientes pasos, no asignes roles (puedes omitirlos).

    - Haz clic en Done.

5. Crea una clave para la cuenta de servicio

    - En la lista de cuentas de servicio, haz clic en los tres puntos sobre la que creaste.

    - Ve a la pesta√±a Keys ‚Üí Add Key ‚Üí Create new key ‚Üí Elige JSON ‚Üí Descargar el archivo .json.

6. **Almacena de forma segura** este archivo `.json`, pues contiene las credenciales privadas que DVC usar√° para autenticarse.

    - En el proyecto puedes guardarlo en la carpeta `configs/credentials/`.

> üìù Este archivo de credenciales ser√° utilizado por DVC como mecanismo de autenticaci√≥n al conectarse con Google Cloud.


### Crear y conectar una carpeta en Google Drive
1. Accede a Google Drive.
2. Crea una nueva carpeta y as√≠gnale un nombre √∫nico (por ejemplo, dvc-mlops-storage).
3. Haz clic derecho sobre la carpeta y selecciona "Compartir".
4. Comparte esa carpeta con el correo electr√≥nico de la cuenta de servicio (XXXX@XXXX.iam.gserviceaccount.com) como Editor
5. Copia el identificador de la carpeta desde la URL. 

    Abre la carpeta en tu navegador y miara la URL. El identificador es lo que va luego de `folders/`:

    https://drive.google.com/drive/u/2/folders/1mOn9UmUYMxqsvEYmk9svT8zf5n9YEhr5


## Parte 2: Configurar Google Cloud Storage como almacenamiento remoto en DVC

!!! note "IMPORTANTE"
    Nota: La cuenta organizacional de la Universidad de Cuenca requiere permisos 
    para crear nuevos proyectos y adem√°s no cuenta con cr√©ditos habilitados para crear un bucket en Google Cloud Storage. Por otro lado, si se utiliza una cuenta individual (por ejemplo, de Gmail), es necesario asociar una tarjeta de cr√©dito v√°lida para activar los servicios de Google Cloud.

    Por este motivo, la creaci√≥n del almacenamiento remoto usando Google Cloud Storage se presenta √∫nicamente con fines informativos y no es un requisito obligatorio para completar esta pr√°ctica.


**Google Cloud Storage (GCS)** puede usarse como un almacenamiento remoto para proyectos gestionados con DVC. Esta opci√≥n es ideal para proyectos colaborativos que requieren mayor capacidad, control de acceso y velocidad de transferencia, especialmente en entornos de producci√≥n o investigaci√≥n. A continuaci√≥n se detallan los pasos para conectar tu proyecto a Google Cloud Storage.

### Crear un Bucket en Google Cloud Storage

1. Accede a Google Cloud Console
    - Ve a [Google Cloud Console](https://console.cloud.google.com/).
    - Aseg√∫rate de haber iniciado sesi√≥n con tu cuenta de Google.
2. Crea un nuevo proyecto (si a√∫n no lo tienes)
    - En la barra superior, haz clic en el selector de proyecto (a la izquierda del buscador). 
    - Haz clic en "Nuevo proyecto".
    - Asigna un nombre representativo (por ejemplo, **Proyecto-MLOPS**).
    - Opcionalmente, selecciona una organizaci√≥n o carpeta.
    - Haz clic en "Crear" y espera unos segundos.
3. Activa el nuevo proyecto    
    - Aseg√∫rate de que el proyecto reci√©n creado est√© seleccionado (aparecer√° en la parte superior de la consola).
4. Ve a Cloud Storage
    - En el men√∫ lateral izquierdo (√≠cono de tres l√≠neas), navega a: Cloud Storage > Buckets
    - Tambi√©n puedes acceder directamente desde:
      [https://console.cloud.google.com/storage/browser](https://console.cloud.google.com/storage/browser).
5. Crea un nuevo bucket
    - Haz clic en el bot√≥n azul "Create".
6. Configura el bucket
    - Nombre del bucket: Debe ser √∫nico globalmente (por ejemplo, mlops-practica-2025).
    - Ubicaci√≥n:
        - Selecciona la regi√≥n **`us-east1`**.
7. Opciones adicionales (puedes dejar por defecto)
    - Clase de almacenamiento: Standard
    - Control de acceso: Uniform
    - Encriptaci√≥n: Google-managed encryption key
    - Haz clic en **"Continue"** hasta completar la creaci√≥n del bucket.
8. Crear
    - Haz clic en "Crear" y espera a que se genere el bucket.
---

### üîê Obtener credenciales para conectar DVC con GCP

Una vez creado el bucket, es necesario obtener las credenciales para conectar el almacenamiento remoto de GCP con tu proyecto DVC:

1. Ve a **IAM & Admin** y selecciona **Service Accounts** en la barra lateral izquierda.
2. Haz clic en el bot√≥n **"Create Service Account"** para crear una nueva cuenta de servicio que usar√°s para conectar con el proyecto DVC.
3. Asigna un **nombre e ID** a esta cuenta (por ejemplo, `lab2`) y deja la configuraci√≥n predeterminada.
4. Haz clic en **"Create and Continue"**.
5. En la secci√≥n de permisos, selecciona **Owner** en el men√∫ desplegable y haz clic en **"Continue"**.
6. A√±ade tu usuario para que tenga acceso a esta cuenta de servicio y haz clic en **"Done"**.

---

### üîë Descargar credenciales

1. Ser√°s redirigido a la p√°gina de **Service Accounts**.
2. Busca tu cuenta de servicio reci√©n creada, haz clic en **"Actions"** (√≠cono de tres puntos), y selecciona **"Manage keys"**.
3. Haz clic en el bot√≥n **"Add Key"**.
4. Selecciona la opci√≥n de generar una nueva clave en formato **JSON**.
5. Descarga y **almacena de forma segura** este archivo `.json`.

> üìù Este archivo de credenciales ser√° utilizado por DVC como mecanismo de autenticaci√≥n al conectarse con Google Cloud.



## Conectar DVC a Google Drive o Google Cloud Storage

En esta pr√°ctica damos las instrucciones para conectar DVC a dos almacenamientos remotos. DVC permite definir m√∫ltiples remotos y seleccionar cu√°l usar como predeterminado o indicar uno espec√≠fico al momento de hacer `dvc push`, `dvc pull`, o `dvc fetch`.

Antes de configurar los accesos remotos debes iniciar DVC usando:
```bash
dvc init
```

Este comando crea la estructura b√°sica del proyecto DVC, incluyendo:

- El directorio .dvc/
- El archivo .dvc/config donde se guardan las configuraciones del almacenamiento remoto.

Es similar a `git init`, pero para el control de versiones de datos. Sin esa estructura, los comandos `dvc remote add` o `dvc remote modify` no tienen d√≥nde escribir la configuraci√≥n, y fallar√°n o no har√°n nada √∫til.

Para configurar dos accesos remotos, podemos usar:
```bash
# Agregar Google Drive como almacenamiento remoto
dvc remote add gdrive-remote gdrive://<ID-de-carpeta>
dvc remote modify gdrive-remote gdrive_use_service_account true
dvc remote modify gdrive-remote gdrive_service_account_json_file_path /ruta/a/credenciales.json

# Agregar Google Cloud Storage como almacenamiento remoto
dvc remote add gcs-remote gs://mi-bucket-dvc
dvc remote modify gcs-remote credentialpath /ruta/a/credenciales.json
```

>Nota: Aqu√≠ no se establece ninguno como predeterminado a√∫n.

### Elegir almacenamiento remoto al hacer `push/pull`

Puedes subir tus datos a un almacenamiento remoto espec√≠fico sin necesidad de cambiar el predeterminado. **Por ahora estos comandos son solo informativos**.

```bash
dvc push -r gdrive-remote     # Subir a Google Drive
dvc push -r gcs-remote        # Subir a GCS
```

### ‚≠ê O definir un almacenamiento remoto por defecto
**Se recomienda establecer alguno de los repositorios por defecto**. Incluso si solo has configurado uno.

```bash
dvc remote default gdrive-remote
```
Luego, cada vez que hagas `dvc push` o `dvc pull`, se usar√° ese sin tener que especificarlo.

!!! note "Recomendaci√≥n"

    Si trabajas con equipos o deseas redundancia en almacenamiento, tener m√∫ltiples remotos puede ayudarte a:

    - Compartir con quienes no tienen acceso a ciertas plataformas.
    - Hacer backups autom√°ticos a diferentes nubes.
    - Evaluar velocidad y costos de acceso.